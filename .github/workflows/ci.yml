name: CI

on:
  push:
    branches: ["**"]
  pull_request:

jobs:
  python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python tooling
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pytest

      - name: Build sample dataset
        run: python scripts/sample_dataset_pipeline.py

      - name: Ruff
        run: ruff check .

      - name: Mypy
        run: mypy packages

      - name: Pytest
        run: pytest

  node:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci --ignore-scripts

      - name: Lint
        run: npm run lint

      - name: Build
        run: npm run build

  eval-gates:
    runs-on: ubuntu-latest
    needs: [python, node]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build sample dataset
        run: python scripts/sample_dataset_pipeline.py

      - name: Select eval mode by branch strategy
        id: branch_mode
        shell: bash
        run: |
          if [[ "${GITHUB_REF}" == "refs/heads/main" || "${GITHUB_REF}" == refs/heads/release/* ]]; then
            echo "required=true" >> "$GITHUB_OUTPUT"
          else
            echo "required=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run eval runner
        shell: bash
        run: |
          MODE="--min-triage-score 0.7"
          if [[ "${{ steps.branch_mode.outputs.required }}" == "true" ]]; then
            MODE="$MODE --required"
          fi
          python -m packages.eval.runner --input data/sample_processed.jsonl $MODE
